import click
from zeep import Client, Settings
from zeep.plugins import HistoryPlugin
import requests
from xml.etree import ElementTree
from bs4 import BeautifulSoup
from base64 import b64decode

def request_factory(cvu):
    return '''
        <soapenv:Envelope
            xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
            xmlns:rep="http://reporteexternocvu.conacyt.gob.mx">
            <soapenv:Header/>
            <soapenv:Body>
                <rep:reporteBytesEjecutivo>
                    <arg0>
                        <usuarioAplicativoCvuVO>
                            <numeroCvu>#{cvu}</numeroCvu>
                        </usuarioAplicativoCvuVO>
                    </arg0>
                </rep:reporteBytesEjecutivo>
            </soapenv:Body>
        </soapenv:Envelope>
        '''.replace("#{cvu}", str(cvu))

@click.command()
def cvu():
    list =[314871,1015948,21820,26245,122187,62252,54560,112143,96147,103127,78899,123089,177961,202621,39607,43458,172629,3505,122068,89746,226449,33981,11196,21226,21226,6653,22006,101612,3588,13866,13634,38901,15485,275264,763374,42258,79122,211507,3652,78079,35948,163306,7050,33848,46794,240996,160290,201331,265369,165076,94362,175390,375974,99716,123192,202420,909,217463,262239,314748,172808,454679,210758,122604,50041,243667,68152,74625,14192,18751,175450,41636,289645,122284,79445,292595,249811,73991,167730,31305,171323,177669,539606,201566,201866,274602,96176,22283,203502,81164,335061,37006,102676,819209,1028575,122263,26369,175473,94341,163647,341161,397999,238664,94546,122079,167994,47934,12850,4666,35153,120355,163019,386858,95028,596879,417939,177968,368635,36406,477272,375675,37411,81075,10231,227623,80244,15582,175513,98240,11386,814610,10353,2780,25914,93070,201987,623695,21636,49288,20352,202806,254162,72690,203512,22199,25248,92586,331017,332964,74240,5352,1030711,203700,330129,120958,346184,11622,30910,37531,85173,546824,35920,14110,21032,214822,51480,84894,213860,209035,165310,264898,41386,441587,5408,121046,120220,267333,42296,179898,242692,35405,162278,93591,262699,215918,321010,164740,756809,38602,203571,254887,230829,295011,815736,22156,37734,19387,404584,22146,202158,103632,200438,467500,169076,333126,30277,253201,33175,42645,201647,66449,100401,88383,337465,1030390,80885,86142,227806,37277,553846,227003,1561,255380,284576,254887,266503,175530,1715,19880,176488,78211,110963,1028969,68016,65037,9391,252033,25012,92595,593261,210428,38316,87217,84788,334455,201164,626326,791485,36139,849432,245796,1030850,435456,218424,4453,20899,1027636,794815,336959,256338,1030373,46850,43324,220296,206842,164464,176144,213434,994438,559904,741909,12869,161623,170381,3511,90979,202044,262498,761988,307882,56971,793197,996286,44249,397882,122487,1031226,396301,21930,1030353,8184,331819,473821,223827,177973,280522,262460,781812,442161,220256,555839,742466,161501,343229,586492,86142,756516]
    url = 'http://vsmiic230:80/cvu/ws/reporteExternoCvu'
    headers = {'x-auth-token': 'f5d57f73-360b-4bf7-8ec1-7843626f7010', 'content-type': 'text/xml'}
    
    for item in list:
        request = request_factory(item)
        resp = requests.post(url, data=request, headers=headers)
        if resp.status_code != 200:
            print(resp.status_code)
        soup = BeautifulSoup(resp.content, features="lxml")
        root = ElementTree.fromstring(soup.prettify())
        for repo in root.iter('archivo'):
            bytes = b64decode(repo.text, validate=False)
            file_name = str(item) + '.pdf' 
            f = open(file_name, 'wb')
            f.write(bytes)
            f.close()

if __name__ == '__main__':
    cvu()